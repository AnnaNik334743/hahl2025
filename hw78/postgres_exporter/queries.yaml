pg_database_size:
  query: "SELECT pg_database.datname, pg_database_size(pg_database.datname) as size_bytes FROM pg_database WHERE datname NOT IN ('template0', 'template1', 'postgres')"
  metrics:
    - datname:
        usage: "LABEL"
        description: "Database name"
    - size_bytes:
        usage: "GAUGE"
        description: "Database size in bytes"

pg_replication_lag:
  query: |
    SELECT 
      CASE WHEN pg_is_in_recovery() THEN 'replica' ELSE 'primary' END as role,
      pg_wal_lsn_diff(pg_current_wal_lsn(), replay_lsn) as lag_bytes,
      EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp())) as lag_seconds
    FROM pg_stat_replication
  metrics:
    - role:
        usage: "LABEL"
        description: "Database role"
    - lag_bytes:
        usage: "GAUGE"
        description: "Replication lag in bytes"
    - lag_seconds:
        usage: "GAUGE"
        description: "Replication lag in seconds"

pg_stat_activity_count:
  query: "SELECT state, count(*) FROM pg_stat_activity WHERE pid <> pg_backend_pid() GROUP BY state"
  metrics:
    - state:
        usage: "LABEL"
        description: "Connection state"
    - count:
        usage: "GAUGE"
        description: "Number of connections in this state"